/**\n * Google Apps Script MCP Server - å®‰å®šç‰ˆ\n * ä¾å­˜é–¢ä¿‚å•é¡Œã‚’è§£æ±ºã—ãŸå®‰å®šå‹•ä½œç‰ˆ\n * \n * Author: Utakata\n */\n\nimport { Server } from '@modelcontextprotocol/sdk/server/index.js';\nimport { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';\nimport {\n  CallToolRequestSchema,\n  ListToolsRequestSchema,\n} from '@modelcontextprotocol/sdk/types.js';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nclass GoogleAppsScriptMCPServer {\n  constructor() {\n    this.server = new Server(\n      {\n        name: 'google-apps-script-mcp',\n        version: '1.1.0',\n      },\n      {\n        capabilities: {\n          tools: {},\n        },\n      }\n    );\n    \n    this.setupHandlers();\n  }\n\n  setupHandlers() {\n    this.server.setRequestHandler(ListToolsRequestSchema, async () => {\n      return {\n        tools: [\n          {\n            name: 'clasp_setup',\n            description: 'Setup Clasp CLI environment and authenticate with Google',\n            inputSchema: {\n              type: 'object',\n              properties: {\n                force: {\n                  type: 'boolean',\n                  description: 'Force re-setup even if already configured'\n                }\n              }\n            }\n          },\n          {\n            name: 'clasp_create',\n            description: 'Create a new Google Apps Script project',\n            inputSchema: {\n              type: 'object',\n              properties: {\n                title: {\n                  type: 'string',\n                  description: 'Title of the new project'\n                },\n                type: {\n                  type: 'string',\n                  enum: ['standalone', 'sheets', 'docs', 'slides', 'forms'],\n                  description: 'Type of Google Apps Script project'\n                }\n              },\n              required: ['title']\n            }\n          },\n          {\n            name: 'clasp_clone',\n            description: 'Clone an existing Google Apps Script project',\n            inputSchema: {\n              type: 'object',\n              properties: {\n                scriptId: {\n                  type: 'string',\n                  description: 'Script ID of the project to clone'\n                },\n                versionNumber: {\n                  type: 'number',\n                  description: 'Version number to clone (optional)'\n                }\n              },\n              required: ['scriptId']\n            }\n          },\n          {\n            name: 'clasp_pull',\n            description: 'Pull latest changes from Google Apps Script',\n            inputSchema: {\n              type: 'object',\n              properties: {\n                versionNumber: {\n                  type: 'number',\n                  description: 'Version number to pull (optional)'\n                }\n              }\n            }\n          },\n          {\n            name: 'clasp_push_and_deploy',\n            description: 'Push changes and deploy to Google Apps Script',\n            inputSchema: {\n              type: 'object',\n              properties: {\n                watch: {\n                  type: 'boolean',\n                  description: 'Watch for file changes and automatically push'\n                },\n                force: {\n                  type: 'boolean',\n                  description: 'Force push even if there are conflicts'\n                }\n              }\n            }\n          },\n          {\n            name: 'clasp_list',\n            description: 'List all Google Apps Script projects',\n            inputSchema: {\n              type: 'object',\n              properties: {}\n            }\n          },\n          {\n            name: 'dependency_check',\n            description: 'Check system dependencies and environment',\n            inputSchema: {\n              type: 'object',\n              properties: {\n                detailed: {\n                  type: 'boolean',\n                  description: 'Show detailed dependency information'\n                }\n              }\n            }\n          }\n        ],\n      };\n    });\n\n    this.server.setRequestHandler(CallToolRequestSchema, async (request) => {\n      switch (request.params.name) {\n        case 'dependency_check':\n          return await this.handleDependencyCheck(request.params.arguments);\n        \n        case 'clasp_setup':\n          return await this.handleClaspSetup(request.params.arguments);\n          \n        case 'clasp_create':\n          return await this.handleClaspCreate(request.params.arguments);\n          \n        case 'clasp_clone':\n          return await this.handleClaspClone(request.params.arguments);\n          \n        case 'clasp_pull':\n          return await this.handleClaspPull(request.params.arguments);\n          \n        case 'clasp_push_and_deploy':\n          return await this.handleClaspPushAndDeploy(request.params.arguments);\n          \n        case 'clasp_list':\n          return await this.handleClaspList(request.params.arguments);\n          \n        default:\n          throw new Error(`Unknown tool: ${request.params.name}`);\n      }\n    });\n  }\n\n  async handleDependencyCheck(args) {\n    try {\n      const nodeVersion = process.version;\n      const platform = process.platform;\n      const architecture = process.arch;\n      \n      // åŸºæœ¬çš„ãªNode.js ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯\n      const dependencies = {\n        'fs/promises': false,\n        'path': false,\n        'child_process': false,\n        'url': false\n      };\n      \n      for (const dep of Object.keys(dependencies)) {\n        try {\n          await import(dep);\n          dependencies[dep] = true;\n        } catch {\n          dependencies[dep] = false;\n        }\n      }\n      \n      // package.json ã®ç¢ºèª\n      let packageInfo = null;\n      try {\n        const packagePath = path.join(__dirname, '..', 'package.json');\n        const packageContent = await fs.readFile(packagePath, 'utf8');\n        packageInfo = JSON.parse(packageContent);\n      } catch {\n        packageInfo = { error: 'package.json not found' };\n      }\n      \n      const result = {\n        status: 'success',\n        environment: {\n          node_version: nodeVersion,\n          platform: platform,\n          architecture: architecture,\n          working_directory: __dirname\n        },\n        dependencies: dependencies,\n        package_info: args?.detailed ? packageInfo : { name: packageInfo?.name, version: packageInfo?.version },\n        timestamp: new Date().toISOString()\n      };\n      \n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`,\n              timestamp: new Date().toISOString()\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async handleClaspSetup(args) {\n    try {\n      const result = {\n        status: 'info',\n        message: 'Claspç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰',\n        steps: [\n          '1. Node.js 18ä»¥ä¸ŠãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª',\n          '2. npm install -g @google/clasp ã§Claspã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«',\n          '3. clasp login ã§Googleèªè¨¼ã‚’å®Œäº†',\n          '4. Google Apps Script APIã‚’æœ‰åŠ¹åŒ–: https://script.google.com/home/usersettings'\n        ],\n        next_action: 'dependency_checkãƒ„ãƒ¼ãƒ«ã§ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„'\n      };\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `Claspã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ${error.message}`\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async handleClaspCreate(args) {\n    try {\n      const result = {\n        status: 'info',\n        message: `Google Apps Script ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæº–å‚™`,\n        project_config: {\n          title: args.title,\n          type: args.type || 'standalone'\n        },\n        command: `clasp create --title \"${args.title}\" --type ${args.type || 'standalone'}`,\n        note: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„'\n      };\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async handleClaspClone(args) {\n    try {\n      const result = {\n        status: 'info',\n        message: 'Google Apps Script ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒ­ãƒ¼ãƒ³æº–å‚™',\n        clone_config: {\n          script_id: args.scriptId,\n          version: args.versionNumber || 'latest'\n        },\n        command: args.versionNumber \n          ? `clasp clone ${args.scriptId} --versionNumber ${args.versionNumber}`\n          : `clasp clone ${args.scriptId}`,\n        note: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãã ã•ã„'\n      };\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `ã‚¯ãƒ­ãƒ¼ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async handleClaspPull(args) {\n    try {\n      const result = {\n        status: 'info',\n        message: 'Google Apps Script ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ«æº–å‚™',\n        pull_config: {\n          version: args.versionNumber || 'latest'\n        },\n        command: args.versionNumber \n          ? `clasp pull --versionNumber ${args.versionNumber}`\n          : 'clasp pull',\n        note: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—ã—ã¦ãã ã•ã„'\n      };\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `ãƒ—ãƒ«ã‚¨ãƒ©ãƒ¼: ${error.message}`\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async handleClaspPushAndDeploy(args) {\n    try {\n      const commands = [];\n      \n      if (args?.force) {\n        commands.push('clasp push --force');\n      } else {\n        commands.push('clasp push');\n      }\n      \n      if (args?.watch) {\n        commands.push('clasp push --watch');\n      }\n      \n      commands.push('clasp deploy');\n      \n      const result = {\n        status: 'info',\n        message: 'Google Apps Script ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™',\n        push_config: {\n          force: args?.force || false,\n          watch: args?.watch || false\n        },\n        commands: commands,\n        note: 'ã“ã‚Œã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§é †æ¬¡å®Ÿè¡Œã—ã¦ãã ã•ã„'\n      };\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼: ${error.message}`\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async handleClaspList(args) {\n    try {\n      const result = {\n        status: 'info',\n        message: 'Google Apps Script ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—',\n        command: 'clasp list',\n        note: 'ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ç¢ºèªã—ã¦ãã ã•ã„'\n      };\n\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify(result, null, 2)\n          }\n        ]\n      };\n    } catch (error) {\n      return {\n        content: [\n          {\n            type: 'text',\n            text: JSON.stringify({\n              status: 'error',\n              message: `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚¨ãƒ©ãƒ¼: ${error.message}`\n            }, null, 2)\n          }\n        ]\n      };\n    }\n  }\n\n  async run() {\n    console.log('ğŸš€ Google Apps Script MCP Server (å®‰å®šç‰ˆ) èµ·å‹•ä¸­...');\n    \n    const transport = new StdioServerTransport();\n    await this.server.connect(transport);\n    console.log('âœ… Google Apps Script MCP Server ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ');\n  }\n}\n\n// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•\nconst server = new GoogleAppsScriptMCPServer();\nserver.run().catch(console.error);\n","numLines":408,"totalLines":408}